<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="formulario.css" />
  <link rel="stylesheet" href="pages/index.css" />
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <title>Registrar Producto</title>
</head>
<body>

  <div id="sidebar-container"></div>
  <script>
    fetch('sidebar.html')
      .then(res => res.text())
      .then(html => document.getElementById('sidebar-container').innerHTML = html);
  </script>

  <div class="container mt-4">
    <h2>
      <button
        onclick="window.location.href='index.html'"
        type="button"
        class="btn btn-secondary"
        style="position: absolute; right: 1cm; top: 50%; transform: translateY(-50%); min-width: 40px; padding: 8px;"
        aria-label="Regresar"
      >
        <span class="material-icons" style="font-size: 24px; vertical-align: middle;">
          arrow_back
        </span>
      </button>
      Registro de Productos
    </h2>

    <form id="formularioAlbergue">
      <details open>
        <summary><strong>Formulario de Registro</strong></summary>
        
  <fieldset class="mt-2">

   <label>Producto:</label>
<select id="selectProducto" name="idProducto" class="form-control mb-2" required>
  <option value="">Cargando productos...</option>
</select>
<fieldset class="mt-2" id="detallesProducto" style="display: none;">
  <label for="id">ID:</label>
  <input type="text" id="id" name="id" class="form-control mb-2" readonly />

  <label for="codigoProducto">Código del Producto:</label>
  <input type="text" id="codigoProducto" name="codigoProducto" class="form-control mb-2" required />

  <label for="nombre">Nombre:</label>
  <input type="text" id="nombre" name="nombre" class="form-control mb-2" required />

  <label for="descripcion">Descripción:</label>
  <textarea id="descripcion" name="descripcion" class="form-control mb-2" rows="3"></textarea>

  <label for="cantidad">Cantidad:</label>
  <input type="number" id="cantidad" name="cantidad" class="form-control mb-2" min="0" required />

  <label for="categoria">Categoría:</label>
<select id="categoria" name="categoria" class="form-control mb-2" required>
  <option value="">Seleccione una categoría</option>
  <option value="Carne">Carne</option>
  <option value="Proteína">Proteína</option>
  <option value="Verdura">Verdura</option>
  <option value="Reperte">Reperte</option>
  <option value="Olores">Olores</option>
  <option value="Abarrotes">Abarrotes</option>
  <option value="Limpieza">Limpieza</option>
  <option value="Mobiliario">Mobiliario</option>
</select>

<label for="unidadMedida">Unidad de Medida:</label>
<select id="unidadMedida" name="unidadMedida" class="form-control mb-2" required>
  <option value="">Seleccione una unidad</option>
  <option value="Mililitros">Mililitros</option>
  <option value="Gramos">Gramos</option>
  <option value="Unidades">Unidades</option>
</select>
</fieldset>
  </fieldset>
  
</details>
          <div id="botonesAcciones" class="mt-3" style="display: none;">
  <button type="button" class="btn btn-success me-2" onclick="actualizarProducto()">Actualizar</button>
  <button type="button" class="btn btn-danger" onclick="eliminarProducto()">Eliminar</button>
</div>
    </form>
  </div>

 <script>
  let productos = [];

  async function llenarSelect(url, selectId, formatOption) {
    try {
      const response = await axios.get(url);
      productos = Array.isArray(response.data) ? response.data : response.data.data || response.data.result || [];
      if (!Array.isArray(productos)) throw new Error("Respuesta inesperada");

      const select = document.getElementById(selectId);
      select.innerHTML = '<option value="">Seleccione una opción</option>';
      productos.forEach(item => {
        const option = document.createElement("option");
        option.value = item.id;
        option.textContent = formatOption(item);
        select.appendChild(option);
      });
    } catch (error) {
      console.error(`Error al llenar ${selectId}:`, error);
    }
  }

  document.getElementById("selectProducto").addEventListener("change", (e) => {
    const productoSeleccionado = productos.find(p => p.id == e.target.value);
    if (!productoSeleccionado) {
      document.getElementById("detallesProducto").style.display = "none";
      document.getElementById("botonesAcciones").style.display = "none";
      return;
    }

    document.getElementById("detallesProducto").style.display = "block";
    document.getElementById("botonesAcciones").style.display = "block";

    document.getElementById("id").value = productoSeleccionado.id;
    document.getElementById("codigoProducto").value = productoSeleccionado.codigoProducto;
    document.getElementById("nombre").value = productoSeleccionado.nombre;
    document.getElementById("descripcion").value = productoSeleccionado.descripcion;
    document.getElementById("cantidad").value = productoSeleccionado.cantidad;
    document.getElementById("categoria").value = productoSeleccionado.categoria;
    document.getElementById("unidadMedida").value = productoSeleccionado.unidadMedida;
  });

  async function actualizarProducto() {
    const id = document.getElementById("id").value;
    const body = {
      id,
      codigoProducto: document.getElementById("codigoProducto").value,
      nombre: document.getElementById("nombre").value,
      descripcion: document.getElementById("descripcion").value,
      cantidad: parseInt(document.getElementById("cantidad").value),
      categoria: document.getElementById("categoria").value,
      unidadMedida: document.getElementById("unidadMedida").value,
    };

    try {
      await axios.put(`https://apiintegrador-production-8ef8.up.railway.app/api/Productos/id/${id}`, body);
      alert("Producto actualizado con éxito.");
    } catch (error) {
      console.error("Error al actualizar:", error);
      alert("Error al actualizar el producto.");
    }
  }

  async function eliminarProducto() {
    const id = document.getElementById("id").value;
    if (!confirm("¿Seguro que deseas eliminar este producto?")) return;

    try {
      await axios.delete(`https://apiintegrador-production-8ef8.up.railway.app/api/Productos/id/${id}`);
      alert("Producto eliminado con éxito.");
      location.reload(); // Recarga la página para refrescar la lista
    } catch (error) {
      console.error("Error al eliminar:", error);
      alert("Error al eliminar el producto.");
    }
  }

  // Cargar productos al inicio
  llenarSelect(
    'https://apiintegrador-production-8ef8.up.railway.app/api/Productos/all',
    'selectProducto',
    i => `Código: ${i.codigoProducto} - ${i.nombre}`
  );
</script>


  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
